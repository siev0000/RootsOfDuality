<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ç”»åƒãƒªã‚¹ãƒˆã‹ã‚‰å†ç”Ÿ</title>
    <style>
      #effect-player {
        width: 120px;
        height: 120px;
        margin: 1em auto;
      }

      #sprite-image {
        position: absolute;
        top: 0;
        left: 0;
        width: auto;
        height: auto;
        image-rendering: pixelated;
        mix-blend-mode: screen; /* â† lightenã‹ã‚‰å¤‰æ›´ */
        pointer-events: none; /* å¿…è¦ãªã‚‰ä¸‹ã‚¯ãƒªãƒƒã‚¯ã‚’é€é */
      }

      #sprite-frame {
        overflow: hidden;
        position: relative;
        background-color: transparent;
        background: none;
        pointer-events: none;

        /* âœ… æ ç·šã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  */
        border: 2px solid rgba(255, 255, 255, 0.6); /* åŠé€æ˜ã®ç™½æ  */
        border-radius: 8px;
        box-shadow: 0 0 8px rgba(255, 255, 255, 0.2); /* ã†ã£ã™ã‚‰å…‰ã‚‹ç¸ */
      }

      /* ãƒœã‚¿ãƒ³ï¼†ã‚»ãƒ¬ã‚¯ãƒˆå…±é€šã®è£…é£¾ */
      .button-like,
      .select-like {
        padding: 0.4em 1em;
        border-radius: 8px;
        font-size: 1em;
        font-weight: bold;
        font-family: "Georgia", serif;
        background: linear-gradient(to bottom, #f3e2c7, #c8a474);
        border: 2px solid #8b5e3c;
        color: #3a2a14;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        margin: 0.5em;
        transition: background 0.2s ease, transform 0.1s ease;
      }
      #effect-selector,
      .button-like:hover,
      .select-like:hover {
        background: linear-gradient(to bottom, #ffe8bc, #d9a96d);
        transform: translateY(-1px);
      }

      #effect-selector,
      .button-like:active,
      .select-like:active {
        transform: scale(0.97);
      }

      /* é…ç½®ãƒ©ãƒƒãƒ‘ãƒ¼ */
      #control-panel {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        gap: 1em;
        margin-top: 1em;
      }
      #effect-panel-background {
        background-color: rgba(0, 0, 0, 0.5);
        color: white; /* ãƒ†ã‚­ã‚¹ãƒˆã‚‚è¦‹ã‚„ã™ãã™ã‚‹ãªã‚‰ */
        margin: 0;
        padding: 0;
        min-height: 100%; /* å…¨ç”»é¢ã«ã™ã‚‹ */
      }
    </style>
  </head>
  <body id="effect-panel-background">
    <h2>ç”»åƒãƒªã‚¹ãƒˆã‹ã‚‰é¸ã‚“ã§å†ç”Ÿ</h2>

    <div id="control-panel">
      <select id="effect-selector"></select>
      <select id="flip-select" class="select-like" onchange="onFlipChange()">
        <option value="none">æ¨™æº–</option>
        <option value="horizontal">å·¦å³åè»¢</option>
        <option value="vertical">ä¸Šä¸‹åè»¢</option>
        <option value="both">ä¸Šä¸‹å·¦å³åè»¢</option>
      </select>

      <button id="play-button" class="button-like">â–¶ å†ç”Ÿ</button>
    </div>

    <div id="effect-player">
      <div id="sprite-frame">
        <img id="sprite-image" src="" />
      </div>
    </div>

    <script>
      let allFiles = [];

      window.addEventListener("DOMContentLoaded", async () => {
        await loadEffectFileList();
        const playButton = document.getElementById("play-button");
        if (playButton) {
          playButton.onclick = playSelected;
        } else {
          console.warn("play-button ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        }
      });

      function onFlipChange() {
        const mode = document.getElementById("flip-select").value;
        const img = document.getElementById("sprite-image");

        switch (mode) {
          case "horizontal":
            img.style.transform = "scaleX(-1)";
            break;
          case "vertical":
            img.style.transform = "scaleY(-1)";
            break;
          case "both":
            img.style.transform = "scale(-1, -1)";
            break;
          default:
            img.style.transform = "scale(1, 1)";
            break;
        }
      }

      async function loadEffectFileList() {
        try {
          const res = await fetch("/data/effect_list.json");
          const list = await res.json();

          if (Array.isArray(list)) {
            allFiles = list;
            console.log("âœ… ã‚¨ãƒ•ã‚§ã‚¯ãƒˆä¸€è¦§:", allFiles);
            populateEffectSelector();
          } else {
            console.error("âŒ ç„¡åŠ¹ãªå½¢å¼:", list);
          }
        } catch (err) {
          console.error("âŒ ã‚¨ãƒ•ã‚§ã‚¯ãƒˆä¸€è¦§å–å¾—å¤±æ•—:", err);
        }
      }


      function populateEffectSelector() {
        const selector = document.getElementById("effect-selector");
        selector.innerHTML = "";

        allFiles.forEach((file) => {
          const option = document.createElement("option");
          option.value = file;
          option.textContent = file;
          selector.appendChild(option);
        });
      }

      function playSelected() {
        const selector = document.getElementById("effect-selector");
        const selectedFile = selector.value;
        const effectImage = document.getElementById("sprite-image");

        console.log("ç”»åƒå†ç”Ÿ");
        if (!selectedFile) {
          alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
          return;
        }

        const path = `/assets/effect/ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé›†/320Ã—240/${encodeURIComponent(selectedFile)}.webp`;

        const preload = new Image();
        preload.onload = () => {
          const effectImage = document.getElementById("sprite-image");
          effectImage.src = path;
          effectImage.style.display = "block";
          effectImage.style.left = "0px";
          effectImage.style.top = "0px";

          adjustEffectContainerWidth(preload); // â† preloadã®ã‚µã‚¤ã‚ºã‚’ä½¿ã£ã¦èª¿æ•´
        };
        preload.src = path;

        playSpriteFixed("sprite-image", 120, 60);
      }

      function playSpriteFixed(
        imageId = "sprite-image",
        unit = 120,
        interval = 100
      ) {
        const img = document.getElementById(imageId);

        img.onload = () => {
          const w = img.naturalWidth;
          const h = img.naturalHeight;
          const isHorizontal = w > h;
          const frameCount = Math.floor((isHorizontal ? w : h) / unit);

          const container = document.getElementById("effect-player");
          const frame = document.getElementById("sprite-frame");
          container.style.width = unit + "px";
          container.style.height = unit + "px";
          frame.style.width = unit + "px";
          frame.style.height = unit + "px";

          let current = 0;
          img.style.left = "0px";
          img.style.top = "0px";

          const timer = setInterval(() => {
            if (isHorizontal) {
              img.style.left = `-${unit * current}px`;
            } else {
              img.style.top = `-${unit * current}px`;
            }
            current++;
            if (current >= frameCount) {
              clearInterval(timer);
              img.style.display = "none";
            }
          }, interval);
        };
      }

      function adjustEffectContainerWidth(img) {
        const container = document.getElementById("effect-player");
        const frame = document.getElementById("sprite-frame");
        if (!img || !container) return;

        const w = img.naturalWidth;
        const h = img.naturalHeight;

        let newWidth;

        if (w > h) {
          newWidth = 120;
          console.log("ğŸ§­ æ¨ªãŒé•·ã„ç”»åƒ â†’ è¡¨ç¤ºå¹… 120px ã«å›ºå®š");
        } else {
          newWidth = w;
          console.log(`ğŸ§­ ç¸¦ãŒé•·ã„ç”»åƒ â†’ ç”»åƒã®æ¨ªå¹… ${w}px ã‚’ä½¿ç”¨`);
        }

        container.style.width = `${newWidth}px`;
        container.style.minWidth = `${newWidth}px`; // â† å¿µã®ãŸã‚è¿½åŠ 
        container.style.maxWidth = `${newWidth}px`;

        if (frame) {
          frame.style.width = `${newWidth}px`;
          frame.style.minWidth = `${newWidth}px`;
          frame.style.maxWidth = `${newWidth}px`;
        }

        console.log(`ğŸ“ #effect-player width = ${newWidth}px`);
      }
    </script>
  </body>
</html>
